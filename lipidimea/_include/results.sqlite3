-- DATABASE SCHEMA FOR DDA-DIA ANALYSIS RESULTS
--
-- -- All non "public-facing" tables are named with prepended _ 


-- table with descriptions of columns from all other tables
CREATE TABLE _TableDescriptions (
    tab_name TEXT NOT NULL,
    col_name TEXT NOT NULL,
    col_desc TEXT NOT NULL
);


----------- Metadata --------------

-- table for tracking data files
CREATE TABLE DataFiles (
    dfile_id INTEGER PRIMARY KEY,
    dfile_type TEXT NOT NULL,
    dfile_name TEXT NOT NULL,
    dfile_notes TEXT,
    dfile_shortname TEXT
) STRICT;
INSERT INTO _TableDescriptions VALUES
    ('DataFiles', 'dfile_id', 'unique data file identifier'),
    ('DataFiles', 'dfile_type', 'specify the type of the data file (e.g. LC-MS/MS DDA, LC-IMS-MS/MS DIA, ...)'),
    ('DataFiles', 'dfile_name', 'data file name (+ path)'),
    ('DataFiles', 'dfile_notes', 'optional additional notes about the data file'),
    ('DataFiles', 'dfile_shortname', 'optional shorthand name for the data file');


----------- Raw/Unprocessed Data --------------

-- table with raw XICs, ATDs, or mass spectra (all as BLOBs)
CREATE TABLE Raw (
    raw_id INTEGER PRIMARY KEY,
    raw_type TEXT NOT NULL,
    feat_id_type TEXT NOT NULL,
    feat_id INT NOT NULL,
    raw_n INT NOT NULL,
    raw_data BLOB NOT NULL
) STRICT;
INSERT INTO _TableDescriptions VALUES 
    ('Raw', 'raw_id', 'unique identifier for this piece of raw data'),
    ('Raw', 'raw_type', 'specify the type of raw data stored (XIC/ATD/MS1/MS2)'),
    ('Raw', 'feat_id_type', 'specify the type of feature identifier used for this piece of raw data, essentially the name of an identifier column from one of the XPrecursors or XFragments tables (e.g. dia_pre_id)'),
    ('Raw', 'feat_id', 'identifier mapping this piece of raw data to some feature (precursors, fragments, etc.)'),
    ('Raw', 'raw_n', 'All of the array data stored here are 2D arrays with shape (2, N), where N is the number of points in the two individual arrays. Store the N value so the data can be reconstructed easily using `numpy.frombuffer(buf).reshape((2, n))`.'),
    ('Raw', 'raw_data', 'the actual data being stored, as a BLOB produced using tobytes() method from numpy.ndarray');


----------- DDA --------------

-- table with LC-MS/MS (DDA) precursors
CREATE TABLE DDAPrecursors (
    dda_pre_id INTEGER PRIMARY KEY,
    dfile_id INT NOT NULL,
    mz REAL NOT NULL,
    rt REAL NOT NULL,
    rt_fwhm REAL NOT NULL,
    rt_pkht REAL NOT NULL,
    rt_psnr REAL NOT NULL,
    ms2_n_scans INT,
    ms2_n_peaks INT
) STRICT;
INSERT INTO _TableDescriptions VALUES 
    ('DDAPrecursors', 'dda_pre_id', 'unique DDA precursor identifier'),
    ('DDAPrecursors', 'dfile_id', 'identifier for the raw data file this feature was extracted from'),
    ('DDAPrecursors', 'mz', 'precursor m/z'),
    ('DDAPrecursors', 'rt', 'observed retention time of chromatographic peak'),
    ('DDAPrecursors', 'rt_fwhm', 'FWHM of chromatographic peak'),
    ('DDAPrecursors', 'rt_pkht', 'height of chromatographic peak'),
    ('DDAPrecursors', 'rt_psnr', 'signal to noise ratio for chromatographic peak'),
    ('DDAPrecursors', 'ms2_n_scans', 'number of MS2 scans for this precursor, optional'),
    ('DDAPrecursors', 'ms2_n_peaks', 'number of peaks in centroided spectrum, optional');

-- table with LC-MS/MS (DDA) fragments
CREATE TABLE DDAFragments (
    dda_frag_id INTEGER PRIMARY KEY,
    dda_pre_id INT NOT NULL,
    fmz REAL NOT NULL,
    fint REAL NOT NULL
) STRICT;
INSERT INTO _TableDescriptions VALUES
    ('DDAFragments', 'dda_pre_id', 'unique DDA fragment identifier'),
    ('DDAFragments', 'dda_frag_id', 'DDA precursor identifier'),
    ('DDAFragments', 'fmz', 'fragment m/z'),
    ('DDAFragments', 'fint', 'fragment intensity');

-- TODO: view that combines DDAPrecursors and DDAFragments into DDAFeatures?


----------- DIA --------------

-- table with LC-IMS-MS/MS (DIA) precursors
CREATE TABLE DIAPrecursors (
    dia_pre_id INTEGER PRIMARY KEY,
    dda_pre_id INT,
    dfile_id INT NOT NULL,
    mz REAL NOT NULL,
    rt REAL NOT NULL,
    rt_fwhm REAL NOT NULL,
    rt_pkht REAL NOT NULL,
    rt_psnr REAL NOT NULL,
    dt REAL NOT NULL,
    dt_fwhm REAL NOT NULL,
    dt_pkht REAL NOT NULL,
    dt_psnr REAL NOT NULL,
    ccs REAL,
    ms2_n_peaks INT
) STRICT;
INSERT INTO _TableDescriptions VALUES 
    ('DIAPrecursors', 'dia_pre_id', 'unique DIA precursor identifier'),
    ('DIAPrecursors', 'dda_pre_id', 'reference to corresponding precursor in DDAPrecursors table, can be NULL before mapping between DDA/DIA precursors is performed'),
    ('DIAPrecursors', 'dfile_id', 'identifier for the raw data file this feature was extracted from'),
    ('DIAPrecursors', 'mz', 'precursor m/z'),
    ('DIAPrecursors', 'rt', 'observed retention time of chromatographic peak'),
    ('DIAPrecursors', 'rt_fwhm', 'FWHM of chromatographic peak'),
    ('DIAPrecursors', 'rt_pkht', 'height of chromatographic peak'),
    ('DIAPrecursors', 'rt_psnr', 'signal to noise ratio for chromatographic peak'),
    ('DIAPrecursors', 'dt', 'observed arrival time of ATD peak'),
    ('DIAPrecursors', 'dt_fwhm', 'FWHM of ATD peak'),
    ('DIAPrecursors', 'dt_pkht', 'height of ATD peak'),
    ('DIAPrecursors', 'dt_psnr', 'signal to noise ratio for ATD peak'),
    ('DIAPrecursors', 'ccs', 'calibrated CCS if available, optional'),
    ('DIAPrecursors', 'ms2_n_peaks', 'number of peaks in centroided spectrum, optional');

-- table with LC-MS/MS (DIA) fragments
CREATE TABLE DIAFragments (
    dia_frag_id INTEGER PRIMARY KEY,
    dia_pre_id INT NOT NULL,
    fmz REAL NOT NULL,
    fint REAL NOT NULL,
    deconvoluted INT NOT NULL,
    xic_dist REAL,
    atd_dist REAL
) STRICT;
INSERT INTO _TableDescriptions VALUES
    ('DIAFragments', 'dia_pre_id', 'unique DIA fragment identifier'),
    ('DIAFragments', 'dia_frag_id', 'DIA precursor identifier'),
    ('DIAFragments', 'fmz', 'fragment m/z'),
    ('DIAFragments', 'fint', 'fragment intensity'),
    ('DIAFragments', 'deconvoluted', 'flag indicating whether the fragment was deconvoluted or not (0=False, 1=True)'),
    ('DIAFragments', 'xic_distance', 'distance metric, relative to precursor XIC (optional, only set for deconvoluted fragments)'),
    ('DIAFragments', 'atd_distance', 'distance metric, relative to precursor ATD (optional, only set for deconvoluted fragments)');

-- TODO: view or table that combines DIAPrecursors and DIAFragments into DIAFeatures?


----------- Lipid Annotations --------------

-- table with Lipid annotations
CREATE TABLE Lipids (
    lipid_id INTEGER PRIMARY KEY,
    dia_pre_id INT NOT NULL,
    lmid_prefix TEXT NOT NULL,
    lipid TEXT NOT NULL,
    adduct TEXT NOT NULL,
    mz_ppm_err REAL NOT NULL,
    ccs_rel_err REAL,
    fragments TEXT
) STRICT;
INSERT INTO _TableDescriptions VALUES 
    ('Lipids', 'lipid_id', 'unique lipid annotation identifier'),
    ('Lipids', 'dia_feat_id', 'reference to precursor identifier from DIAPrecursors table'),
    ('Lipids', 'lipid', 'lipid annotation, made at the level of sum composition or higher if supporting fragment(s) found in MS2 spectrum'),
    ('Lipids', 'lmaps_id_prefix', 'LipidMAPS ID prefix (reflects lipid category, class, and sub-class)'),
    ('Lipids', 'adduct', 'MS adduct/ionization state'),
    ('Lipids', 'mz_ppm_err', 'mass error in ppm relative to theoretical monoisotopic mass'),
    ('Lipids', 'ccs_rel_err', 'relative CCS error in percent'),
    ('Lipids', 'fragments', 'annotated peaks from MS2 spectrum in single line "{label}_{mz} {label}_{mz} ..." format');
